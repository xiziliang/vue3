<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<body>
    <canvas id="paper" width="0" height="0"></canvas>
</body>

<script type="module">
    import { myGetImageData, loadImage, traverse , gaussianBlur , transformColor} from './utils.js';
    function brightness(p) {
      return [
        p, 0, 0, 0, 0,
        0, p, 0, 0, 0,
        0, 0, p, 0, 0,
        0, 0, 0, 1, 0,
      ];
    }

    function saturate(p) {
      const r = 0.212 * (1 - p);
      const g = 0.714 * (1 - p);
      const b = 0.074 * (1 - p);
      return [
        r + p, g, b, 0, 0,
        r, g + p, b, 0, 0,
        r, g, b + p, 0, 0,
        0, 0, 0, 1, 0,
      ];
    }

    function grayscale(p) {
      const r = 0.212 * p;
      const g = 0.714 * p;
      const b = 0.074 * p;

      return [
        r + 1 - p, g, b, 0, 0,
        r, g + 1 - p, b, 0, 0,
        r, g, b + 1 - p, 0, 0,
        0, 0, 0, 1, 0,
      ];
    }

    function channel({r = 1, g = 1, b = 1}) {
      return [
        r, 0, 0, 0, 0,
        0, g, 0, 0, 0,
        0, 0, b, 0, 0,
        0, 0, 0, 1, 0,
      ];
    }

    const canvas = document.getElementById('paper');
    const context = canvas.getContext('2d');

    (async function () {
        /** @type {HTMLCanvasElement} */

        // 异步加载图片
        const img = await loadImage('https://p2.ssl.qhimg.com/d/inn/4b7e384c55dc/girl1.jpg');
        const imageData = myGetImageData(img);
        //图片灰度化
        traverse(imageData, ({ r, g, b, a }) => { // 对每个像素进行灰度化处理 
            return transformColor(
                [r, g, b, a],
                channel({r: 1,g:1}), // 增强红色通道
                brightness(1.2), // 增强亮度
                saturate(1.5), // 增强饱和度
            )
        });

        // 高斯模糊
        const {width, height, data} = imageData;
        gaussianBlur(data, width, height,5);

        canvas.width = imageData.width; 
        canvas.height = imageData.height; 
        context.putImageData(imageData, 0, 0);
        // let data = imageData.data;
        // for (let i = 0; i < data.length; i++) {
        //     const r = data[i],
        //         g = data[i + 1],
        //         b = data[i + 2],
        //         a = data[i + 3];
        //     // 对RGB通道进行加权平均 
        //     const v = 0.2126 * r + 0.7152 * g + 0.0722 * b; // 人的视觉对 R、G、B 三色通道的敏感度是不一样的,所以不是平分
        //     data[i] = v;
        //     data[i + 1] = v;
        //     data[i + 2] = v;
        //     data[i + 3] = a;
        // }
        // canvas.width = imageData.width; 
        // canvas.height = imageData.height; 
        // context.putImageData(imageData,0,0);
    }());
</script>

</html>